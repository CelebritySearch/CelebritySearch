<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

	<head>
    	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
      	<title>Celebrity Twitter Search</title>
    	<link rel="stylesheet" href="style.css" type="text/css">
   		<link href="libs/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
	</head>

	<body id="index">
	 <div class="well" id="wrapper"> <!--  evtl noch "container"-->

	    <h1><center>Celebrity Twitter Search</center></h1>
	    <div>
	    <form class="form-search text-center">
		  <input type="text" class="input-xxlarge" id="inputSearch">
		  <button type="submit" class="btn btn-large btn-primary button-custom" id="search-button" href="#"><i class="icon-search icon-white"></i> Search</button>
		</form>
		</div>

		<div class="well container">

			<div class="well container" id="detailansicht">
				<a class="btn btn-danger pull-right" id="close-button" href="#"><i class="icon-remove"></i></a>
				<h3 id="ueberschrift"></h3>

			    <div class="tabbable"> <!-- Only required for left/right tabs -->
				    <ul class="nav nav-tabs">
					    <li id="tab-promis"><a href="#tab1" data-toggle="tab"><i class="icon-user"></i> Promis</a></li>
					    <li id="tab-tweets" class="active"><a href="#tab2" data-toggle="tab"><i class="icon-list"></i> Tweets</a></li>
				    </ul>
				    <div class="tab-content">
					    <div id="section-promis" class="tab-pane" id="tab1">
					    	<div class="row" id="promi-section">
						    	<!--<div class="span4">
						    		<ul class="thumbnails text-center celebrity-section" id="celebrity-one">
								    <div class="thumbnail" id="celebrity1">
								    <h4>Promi 1</h4>
								    <img src="img/schauspieler.png" class="img-rounded">
								    </div>  
									</ul>
								</div>

								<div class="span4">
									<ul class="thumbnails text-center celebrity-section" id="celebrity-two">
									    <div class="thumbnail" id="celebrity2">
									    <h4>Promi 2</h4>
									    <img src="img/schauspieler.png" class="img-rounded">
									    </div>  
									</ul>
								</div>
								<div class="span4">
									<ul class="thumbnails text-center celebrity-section" id="celebrity-three">
									    <div class="thumbnail" id="celebrity3">
									    <h4>Promi 3</h4>
									    <img src="img/schauspieler.png" class="img-rounded">
									    </div>  
									</ul>
								</div>-->
							</div>
					    </div>
					    <div id="section-tweets" class="tab-pane active" id="tab2">
					    <!-- 
					    	<div class="tweet" id="section-tweet1">
					    		<img src="img/schauspieler.png" class="tweet-pic">
					    		<div class="tweet-data">
					    			<p class="celebrity-name">Promi Name</p>
					    			<p class="tweet-text">blbalablabl</p>
					    		</div>
					    	</div> -->
						</div>
			    	</div>
	    		</div>	
			</div>

			<ul class="thumbnails text-center" id="schauspieler">
			    <div class="thumbnail category-thumbnail" id="Schauspieler">
			    <h4>Schauspieler</h4>
			      <img src="img/schauspieler.png" class="img-rounded">
			    </div>  
			</ul>

			<ul class="thumbnails text-center"id="sportler">
			    <div class="thumbnail category-thumbnail" id="Sportler">
			      <h4>Sportler</h4>
			      <img src="img/fussball.png" class="img-rounded">
			      
			    </div>
			</ul>

			<ul class="thumbnails text-center"id="comedians">
			    <div class="thumbnail category-thumbnail" id="Comedians">
			      <h4>Comedians</h4>
			      <img src="img/comedy.png" class="img-rounded">
			      
			    </div>
			</ul>

			<ul class="thumbnails text-center"id="musiker">			  
			    <div class="thumbnail category-thumbnail" id="Musiker">
			      <h4>Musiker</h4>
			      <img src="img/musik.png" class="img-rounded">
			      
			    </div>			  
			</ul>

			<ul class="thumbnails text-center"id="mode">
			    <div class="thumbnail category-thumbnail" id="Mode">
			      <h4>Mode</h4>
			      <img src="img/fashion.png" class="img-rounded">
			      
			    </div>		  
			</ul>

			<ul class="thumbnails text-center"id="politiker">  
			    <div class="thumbnail category-thumbnail" id="Politiker">
			      <h4>Politiker</h4>
			      <img src="img/politik.png" class="img-rounded">
			      
			    </div>			  			  
			</ul>

			<ul class="thumbnails text-center"id="autoren">
			    <div class="thumbnail category-thumbnail" id="Autoren">
			      <h4>Autoren</h4>
			      <img src="img/autoren.png" class="img-rounded">
			      
			    </div>			  			  
			</ul>

			<ul class="thumbnails text-center"id="reality-stars">
			    <div class="thumbnail category-thumbnail" id="Reality-Stars">
			      <h4>Reality-Stars</h4>
			      <img src="img/reality-stars.png" class="img-rounded">
			      
			    </div>
			</ul>

			<ul class="thumbnails text-center"id="moderatoren">			  
			    <div class="thumbnail category-thumbnail" id="Moderatoren">
			      <h4>Moderatoren</h4>
			      <img src="img/moderatoren.png" class="img-rounded">
			      
			    </div>			  
			</ul>

		</div>
	
	<ul class="nav nav-tabs nav-stacked well" id="facetted-search">
	  	<li>
		  	<a href="#">
		  	<label class="checkbox">
	      		<input type="checkbox" class="optionsFacettedSearch" id="optionSchauspieler">Schauspieler</label>
	    	</a>
     	</li>
	  	<li>
		  	<a href="#">
		  	<label class="checkbox">
	      		<input type="checkbox" class="optionsFacettedSearch" id="optionSportler">Sportler</label>
	    	</a>
     	</li>
	  	<li>
		  	<a href="#">
		  	<label class="checkbox">
	      		<input type="checkbox" class="optionsFacettedSearch" id="optionComedians">Comedians</label>
	    	</a>
     	</li>
     	<li>
		  	<a href="#">
		  	<label class="checkbox">
	      		<input type="checkbox" class="optionsFacettedSearch" id="optionMusiker">Musiker</label>
	    	</a>
     	</li>
     	<li>
		  	<a href="#">
		  	<label class="checkbox">
	      		<input type="checkbox" class="optionsFacettedSearch" id="optionMode">Mode</label>
	    	</a>
     	</li>
     	<li>
		  	<a href="#">
		  	<label class="checkbox">
	      		<input type="checkbox" class="optionsFacettedSearch" id="optionPolitiker">Politiker</label>
	    	</a>
     	</li>
     	<li>
		  	<a href="#">
		  	<label class="checkbox">
	      		<input type="checkbox" class="optionsFacettedSearch" id="optionSchriftsteller">Autoren</label>
	    	</a>
     	</li>
     	<li>
		  	<a href="#">
		  	<label class="checkbox">
	      		<input type="checkbox" class="optionsFacettedSearch" id="optionReality-Stars">Reality-Stars</label>
	    	</a>
     	</li>
     	<li>
		  	<a href="#">
		  	<label class="checkbox">
	      		<input type="checkbox" class="optionsFacettedSearch" id="optionModeratoren">Moderatoren</label>
	    	</a>
     	</li>
	</ul>

	</div>

	<script src="libs/jquery-1.9.1.min.js"></script>
	<script src="libs/underscore-min.js"></script>
	<script type="text/javascript">
	var categories = [];
	
	$(".category-thumbnail").on("click", function(event){
		var category = $(this).attr("id");
		categories = [];
	 	categories.push(category);

	 	var query = $('#inputSearch').val();

		fillPromiSection({category: categories, query: query});
		fillTweetSection({category: categories, query: query});

	 	$("#detailansicht").fadeIn(300);
	 	document.getElementById("ueberschrift").innerHTML = category;
	 	$("#facetted-search").fadeIn(300);
	 	$(".optionsFacettedSearch").prop("checked", false);
	 	$("#option" + category).prop("checked", true);
	});

	$("#close-button").on("click", function(event){
		categories = [];
	 	$("#detailansicht").fadeOut(300);
	 	$("#facetted-search").fadeOut(300);
	});

	$("#search-button").on("click", function(event){
		event.preventDefault();
	 	$("#detailansicht").fadeIn(300);
	 	$("#tab-tweets").addClass("active");
	 	$("#section-tweets").addClass("active");

	 	fillTweetSection({category: categories, query: $('#inputSearch').val()});
	 	fillPromiSection({category: categories, query: $('#inputSearch').val()});

	 	$("#tab-promis").removeClass("active");
	 	$("#section-promis").removeClass("active");
	 	$("#facetted-search").fadeIn(300);
	});

	$("#tab-promis").on("click", function(event){
	 	$("#tab-tweets").removeClass("active");
	 	$("#section-tweets").removeClass("active");
	 	$("#section-promis").addClass("active");
	 	$("#tab-promis").addClass("active");
	});
 	
 	$("#tab-tweets").on("click", function(event){
	 	$("#tab-tweets").addClass("active");
	 	$("#section-tweets").addClass("active");
	 	$("#tab-promis").removeClass("active");
	 	$("#section-promis").removeClass("active");
	});
	

	$(".checkbox").on("click", function(event){
		var checkboxEls = $("#facetted-search").find(".checkbox");
		for(var i = 0; i<checkboxEls.length; i++){
			var checkbox = $(checkboxEls[i]).find(".optionsFacettedSearch");
			var category = ($(checkboxEls[i]).text().replace(/[\n|\s|\r|\t]*/,""));
			if($(checkbox).prop("checked") == true){
				if(categories.indexOf(category) == -1){
					categories.push(category);
				}
			} else {
				categories = _.without(categories, category);
			}
		}

		var query = null;
		if($("#inputSearch").val() != ''){
			query = $('#inputSearch').val();
		}

		fillTweetSection({category: categories, query: query});
		fillPromiSection({category: categories, query: query});
		if(categories.length == 1){
			document.getElementById("ueberschrift").innerHTML = categories[0];
		}
		else if(categories.length == 0){
			document.getElementById("ueberschrift").innerHTML = "Alle Kategorien";		
		} else {
			document.getElementById("ueberschrift").innerHTML = "Kategorisierte Suche";		
		}		
	});

	function createTweetView(name, text, profile_image_url, time, screen_name){
		var view = $('<div class="tweet"><img src="img/schauspieler.png" class="tweet-pic"><div class="tweet-data"><div class="tweet-time"></div><p class="celebrity-name">Promi Name</p><p class="tweet-text">blbalablabl</p></div></div>');
		$(view.find('.tweet-time')[0]).text(time);
		$(view.find('.tweet-pic')[0]).attr("src", profile_image_url);
		$(view.find('.celebrity-name')[0]).text(name);
		$(view.find('.celebrity-name')[0]).on('click', function(event){
			fillTweetSection({screen_name: screen_name});
		});
		$(view.find('.tweet-text')[0]).text(text);

		return view;
	};

	function createPromiView(name, profile_image_url, screen_name){
		var view = $('<div class="span4"><ul class="thumbnails text-center celebrity-section"><div class="thumbnail celebrity-thumbnail"><h4 class="promi-name">Promi 1</h4><img src="img/schauspieler.png" class="img-rounded promi-pic" ><p class="promi-screen_name"></p></div></ul></div>');
		$(view.find('.promi-pic')[0]).attr("src", profile_image_url);
		$(view.find('.promi-name')[0]).text(name);
		$(view.find('.promi-screen_name')[0]).text('@'+screen_name);
		view.on('click', function(event){

			$("#tab-tweets").addClass("active");
			$("#section-tweets").addClass("active");
			$("#tab-promis").removeClass("active");
			$("#section-promis").removeClass("active");

			fillTweetSection({screen_name: screen_name});
		});

		return view;
	};

	function fillPromiSection(param){
		deleteButtonMore();
		var $promiSection = $("#promi-section");
		if(!param.numPromis){
			$promiSection.empty();
			param.numPromis = 0;
		}

		if(param.category.length == 0){
			param.category = "*";
		}

		$.get('/celeb', {category: param.category, search: param.query, start: param.numPromis, screen_name: param.screen_name}, function(celebs){
			var length = celebs.length;

			for(var i = 0; i<length; i++){
				$promiSection.append(createPromiView(celebs[i].name, celebs[i].profile_image_url, celebs[i].screen_name));
				param.numPromis++;
			}

			if(celebs.length == 0){
				$promiSection.append("<p>Keine Ergebnisse gefunden!<p>");
			}
			
			if(celebs.length > 24){
				var buttonMore = createButtonMore();
				$promiSection.append(buttonMore);

				$(buttonMore).on("click", function(){
					fillPromiSection({
						category: param.category,
						query: param.query,
						screen_name: param.fscreen_name,
						numPromis: param.numPromis,
					});
				});
			}
		});
	};

	function fillTweetSection(param){
		var $tweetSection = $('#section-tweets');
		if(!param.numTweets){
			$tweetSection.empty();
			param.numTweets = 0;
		}

		if(param.category){
			if(param.category.length == 0){
				param.category = "*";
			}
		}

		$.get('/tweets', { category: param.category, search: param.query, screen_name: param.screen_name, start: param.numTweets }, function(tweets){
			var length = tweets.length;

			for(var i = 0; i <length; i++){
				$tweetSection.append(createTweetView(tweets[i].user_name, tweets[i].text, tweets[i].profile_image_url, new Date(tweets[i].created_at).toLocaleString(), tweets[i].screen_name));
				param.numTweets++;
			}

			if(tweets.length == 0){
				$tweetSection.append("<p>Keine Ergebnisse gefunden!<p>");
			}
			
			if(tweets.length > 24){
				var buttonMore = createButtonMore();
				$tweetSection.append(buttonMore);

				$(buttonMore).on("click", function(){
					$(buttonMore).remove();
					fillTweetSection({category: param.category, search: param.query, screen_name: param.screen_name, numTweets: param.numTweets});	
				});
			}	
		});
	}

	function createButtonMore(){
		var button = $('<button class="btn" id="button-more" type="button">Mehr</button>');
		return button;
	};

	function deleteButtonMore(){
		$("#button-more").remove();
	};

 	function openCelebStream(screen_name){
 		$.get('/celeb', { screen_name: screen_name }, function(data){
 			var docs = data.response.docs;
 			if(docs.length > 0){
				var celebId = parseInt(docs[0].id);
				socket.emit('celebStream', { celebId: celebId });
 			} else {
 				throw new Error("Celebrity with screen_name: " + screen_name + " not found.");
 			}
 		});
 	}
	</script>
		
	</body>
</html>